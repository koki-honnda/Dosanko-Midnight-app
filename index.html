<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dosanko Midnight App - Pro</title>
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; height: 100vh; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* メニュー周り */
        .menu-trigger { position: absolute; top: 15px; right: 15px; z-index: 100; background: white; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); cursor: pointer; font-size: 24px; }
        .side-menu { position: absolute; top: 0; right: -310px; width: 280px; height: 100vh; background: rgba(255, 255, 255, 0.98); z-index: 90; transition: 0.3s; padding: 70px 15px 100px; box-shadow: -2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
        .side-menu.open { right: 0; }
        
        button { padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 13px; font-weight: bold; cursor: pointer; }
        button.active { background: #ff4444 !important; color: white !important; }
        .section-title { font-size: 11px; color: #888; margin-top: 15px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        /* 地点ラベル用のスタイル */
        .map-label { background: white; border: 2px solid #333; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 14px; white-space: nowrap; }

        #status-msg { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); z-index: 80; background: rgba(255,0,0,0.8); color: white; padding: 8px 20px; border-radius: 20px; font-size: 12px; display: none; }
        .undo-panel { position: absolute; bottom: 30px; left: 15px; z-index: 80; display: none; }
    </style>
</head>
<body>

<div id="status-msg">道路に修正中...</div>
<div class="menu-trigger" onclick="toggleMenu()">⋮</div>

<div id="side-menu" class="side-menu">
    <div class="section-title">表示設定</div>
    <button onclick="changeMapStyle('osm')">標準地図</button>
    <button onclick="changeMapStyle('sat')">航空写真</button>

    <div class="section-title">ルート作成</div>
    <div style="display:flex; gap:4px;">
        <button id="drawModeBtn" onclick="toggleMode('draw')">なぞる</button>
        <button id="markerModeBtn" onclick="toggleMode('marker')">地点登録</button>
    </div>
    <button onclick="saveToCloud()" style="background:#e3f2fd;">クラウドに保存・共有</button>
    <button onclick="clearCurrent()" style="font-size:11px;">リセット</button>

    <div class="section-title">共有ルート</div>
    <div id="route-list"></div>

    <div class="section-title">設定</div>
    <button onclick="toggleTracking()" id="trackBtn">追従モード: OFF</button>
    <button onclick="fullReset()" style="color:red; font-size:10px;">アプリ初期化</button>
</div>

<div id="undo-panel" class="undo-panel">
    <button onclick="undoLastAction()" style="background:#333; color:white;">↩ 1つ戻す</button>
</div>

<div id="map"></div>

<script>
    // --- Firebase設定 ---
    const firebaseConfig = {
        apiKey: "AIzaSyCM1JORf6ntrSjgD8_Scx1aogVmmjoMmYk",
        authDomain: "dosanko-midnight-app.firebaseapp.com",
        projectId: "dosanko-midnight-app",
        storageBucket: "dosanko-midnight-app.firebasestorage.app",
        messagingSenderId: "740298034300",
        appId: "1:740298034300:web:05ea779fddaf7fab480df9",
        measurementId: "G-0B0NF4EBLG",
        databaseURL: "https://dosanko-midnight-app-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const MY_ID = localStorage.getItem('dosanko_user_id') || 'u_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('dosanko_user_id', MY_ID);

    // --- 地図設定 ---
    const SAPPORO = [141.30, 43.10]; // 手稲・石狩付近
    const styles = {
        osm: { version: 8, sources: { 'osm': { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 } }, layers: [{ id: 'osm', type: 'raster', source: 'osm' }] },
        sat: { version: 8, sources: { 'sat': { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 } }, layers: [{ id: 'sat', type: 'raster', source: 'sat' }] }
    };

    const map = new maplibregl.Map({
        container: 'map',
        style: styles.osm,
        center: SAPPORO, zoom: 12
    });

    let currentRoute = [];
    let currentMarkers = []; // 地点情報の保存用
    let routeHistory = [];
    let mode = 'none';
    let isTracking = false;

    map.on('load', () => {
        map.addSource('route', { type: 'geojson', data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [[0,0],[0,0]] } } });
        map.addLayer({ id: 'route-layer', type: 'line', source: 'route', paint: { 'line-color': '#ff0000', 'line-width': 6 } });
        syncCloudRoutes();
    });

    // --- 機能切替 ---
    function toggleMode(m) {
        mode = (mode === m) ? 'none' : m;
        document.getElementById('drawModeBtn').classList.toggle('active', mode === 'draw');
        document.getElementById('markerModeBtn').classList.toggle('active', mode === 'marker');
        document.getElementById('undo-panel').style.display = (mode === 'draw') ? 'block' : 'none';
        if (mode === 'draw') { map.dragPan.disable(); map.touchZoomRotate.disable(); toggleMenu(); }
        else { map.dragPan.enable(); map.touchZoomRotate.enable(); }
    }

    function changeMapStyle(s) { map.setStyle(styles[s]); toggleMenu(); }

    // --- なぞり描きと「車道補正」 ---
    map.on('mousemove', (e) => { if(mode==='draw') { currentRoute.push([e.lngLat.lng, e.lngLat.lat]); updateMapLine(); } });
    map.on('touchmove', (e) => { if(mode==='draw') { currentRoute.push([e.lngLat.lng, e.lngLat.lat]); updateMapLine(); } });

    async function finalizeDrawing() {
        if(mode !== 'draw' || currentRoute.length < 5) return;
        routeHistory.push(JSON.stringify({route: currentRoute, markers: currentMarkers}));
        
        const status = document.getElementById('status-msg');
        status.style.display = 'block';

        // 道路補正 (Drivingモード / 検索半径を50mに拡大)
        const step = Math.max(1, Math.floor(currentRoute.length / 90));
        const sampled = currentRoute.filter((_, i) => i % step === 0);
        const coordsStr = sampled.map(c => `${c[0]},${c[1]}`).join(';');
        
        try {
            const url = `https://router.project-osrm.org/match/v1/driving/${coordsStr}?overview=full&geometries=geojson&radiuses=${sampled.map(()=>50).join(';')}`;
            const res = await fetch(url).then(r => r.json());
            if (res.code === 'Ok') {
                currentRoute = res.matchings[0].geometry.coordinates;
                updateMapLine();
            }
        } catch (e) { console.error(e); }
        status.style.display = 'none';
    }
    map.on('mouseup', finalizeDrawing);
    map.on('touchend', finalizeDrawing);

    // --- 地点登録 (マーカー) ---
    map.on('click', (e) => {
        if (mode !== 'marker') return;
        const label = prompt("地点の名前を入力 (例: 石狩ランプ)");
        if (!label) return;
        addLabelMarker(label, [e.lngLat.lng, e.lngLat.lat]);
    });

    function addLabelMarker(text, lngLat) {
        const el = document.createElement('div');
        el.className = 'map-label';
        el.innerText = text;
        const m = new maplibregl.Marker({ element: el }).setLngLat(lngLat).addTo(map);
        currentMarkers.push({ text, lngLat });
    }

    // --- 保存と読み込み ---
    function saveToCloud() {
        const name = prompt("保存名", "ルート " + new Date().toLocaleTimeString());
        if(!name) return;
        db.ref('shared_routes').push({ name, coords: currentRoute, markers: currentMarkers, creator: MY_ID, timestamp: Date.now() });
        alert("保存完了");
    }

    function syncCloudRoutes() {
        db.ref('shared_routes').on('value', (snapshot) => {
            const list = document.getElementById('route-list');
            list.innerHTML = '';
            const data = snapshot.val();
            for(let id in data) {
                const item = document.createElement('div');
                item.style = "padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;";
                item.innerHTML = `<span onclick="loadCloudRoute('${id}')">${data[id].name}</span>
                    ${data[id].creator===MY_ID ? `<button onclick="db.ref('shared_routes/${id}').remove()" style="padding:2px 5px;">削</button>`:''}`;
                list.appendChild(item);
            }
        });
    }

    function loadCloudRoute(id) {
        db.ref('shared_routes/' + id).once('value', (s) => {
            const d = s.val();
            currentRoute = d.coords;
            updateMapLine();
            // 既存マーカー消去
            document.querySelectorAll('.map-label').forEach(el => el.remove());
            currentMarkers = [];
            if(d.markers) d.markers.forEach(m => addLabelMarker(m.text, m.lngLat));
            map.flyTo({ center: currentRoute[0] });
            toggleMenu();
        });
    }

    function updateMapLine() { map.getSource('route').setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: currentRoute.length>1?currentRoute:[[0,0],[0,0]] } }); }
    function clearCurrent() { currentRoute = []; currentMarkers = []; updateMapLine(); document.querySelectorAll('.map-label').forEach(el => el.remove()); }
    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }
</script>
</body>
</html>
