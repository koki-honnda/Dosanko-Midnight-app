<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Navi App - Navigation</title>
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .ui-panel {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px;
            width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .nav-info {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 10; background: rgba(0,0,0,0.8); color: white;
            padding: 10px 20px; border-radius: 30px; font-size: 18px; font-weight: bold;
            display: none; text-align: center; min-width: 150px;
        }
        button { width: 100%; margin: 4px 0; padding: 10px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; }
        .active { background: #ff4444 !important; color: white; }
        .tracking-on { background: #44ff44; }
        #route-list { margin-top: 10px; max-height: 120px; overflow-y: auto; font-size: 12px; }
        .route-item { border-bottom: 1px solid #eee; padding: 5px 0; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="ui-panel">
    <button id="trackBtn" onclick="toggleTracking()">追従モード: OFF</button>
    <button id="autoModeBtn" onclick="toggleMode('auto')">自動ルート作成</button>
    <button onclick="saveCurrentRoute()">ルートを保存</button>
    <button onclick="clearMap()" style="background:#eee;">クリア</button>
    <div id="route-list"><strong>保存済みルート</strong></div>
</div>

<div id="nav-info" class="nav-info">
    あと <span id="distance">-</span>
</div>

<div id="map"></div>

<script>
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: { 'osm': { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256, attribution: '© OSM' } },
            layers: [{ id: 'osm-layer', type: 'raster', source: 'osm' }]
        },
        center: [139.767, 35.681],
        zoom: 15
    });

    let isTracking = false;
    let watchId = null;
    let userMarker = new maplibregl.Marker({ color: '#007bff' });
    let currentRoute = [];
    let mode = 'none';

    map.on('load', () => {
        map.addSource('route', { type: 'geojson', data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [] } } });
        map.addLayer({ id: 'route-layer', type: 'line', source: 'route', paint: { 'line-color': '#ff4444', 'line-width': 6, 'line-opacity': 0.8 } });
        updateRouteList();
    });

    // --- 追従モードの切り替え ---
    function toggleTracking() {
        isTracking = !isTracking;
        const btn = document.getElementById('trackBtn');
        const navInfo = document.getElementById('nav-info');

        if (isTracking) {
            btn.innerText = "追従モード: ON";
            btn.classList.add('tracking-on');
            navInfo.style.display = 'block';
            startTracking();
        } else {
            btn.innerText = "追従モード: OFF";
            btn.classList.remove('tracking-on');
            navInfo.style.display = 'none';
            stopTracking();
        }
    }

    function startTracking() {
        if (!navigator.geolocation) return alert("GPSが使えません");

        watchId = navigator.geolocation.watchPosition(pos => {
            const { latitude, longitude } = pos.coords;
            const userCoords = [longitude, latitude];

            userMarker.setLngLat(userCoords).addTo(map);
            
            if (isTracking) {
                map.easeTo({ center: userCoords, duration: 1000 });
            }

            // 目的地（ルートの終点）までの距離計算
            if (currentRoute.length > 0) {
                const destination = currentRoute[currentRoute.length - 1];
                const dist = calculateDistance(longitude, latitude, destination[0], destination[1]);
                document.getElementById('distance').innerText = dist;
            }
        }, err => console.error(err), { enableHighAccuracy: true });
    }

    function stopTracking() {
        if (watchId) navigator.geolocation.clearWatch(watchId);
    }

    // --- 距離計算 (ハバーサイン公式) ---
    function calculateDistance(lon1, lat1, lon2, lat2) {
        const R = 6371; // 地球の半径 km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const d = R * c;
        return d > 1 ? d.toFixed(2) + " km" : (d * 1000).toFixed(0) + " m";
    }

    // --- ルート作成機能 (前回と同じ) ---
    function toggleMode(newMode) {
        mode = (mode === newMode) ? 'none' : newMode;
        document.getElementById('autoModeBtn').classList.toggle('active', mode === 'auto');
    }

    map.on('click', async (e) => {
        if (mode !== 'auto') return;
        const coords = [e.lngLat.lng, e.lngLat.lat];
        if (currentRoute.length > 0) {
            const start = currentRoute[currentRoute.length - 1];
            const url = `https://router.project-osrm.org/route/v1/walking/${start[0]},${start[1]};${coords[0]},${coords[1]}?overview=full&geometries=geojson`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.routes[0]) currentRoute = currentRoute.concat(data.routes[0].geometry.coordinates);
        } else {
            currentRoute.push(coords);
        }
        updateMapLine();
    });

    function updateMapLine() {
        map.getSource('route').setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: currentRoute } });
    }

    function saveCurrentRoute() {
        if (currentRoute.length === 0) return;
        const name = prompt("ルート名", "保存ルート " + new Date().toLocaleTimeString());
        if (!name) return;
        const saved = JSON.parse(localStorage.getItem('my_routes') || '[]');
        saved.push({ name, data: currentRoute });
        localStorage.setItem('my_routes', JSON.stringify(saved));
        updateRouteList();
    }

    function updateRouteList() {
        const list = document.getElementById('route-list');
        list.innerHTML = '<strong>保存済みルート</strong>';
        JSON.parse(localStorage.getItem('my_routes') || '[]').forEach((r, i) => {
            const div = document.createElement('div');
            div.className = 'route-item';
            div.innerHTML = `<span>${r.name}</span> <button onclick="loadRoute(${i})" style="width:40px; padding:2px;">表示</button>`;
            list.appendChild(div);
        });
    }

    function loadRoute(index) {
        const saved = JSON.parse(localStorage.getItem('my_routes') || '[]');
        currentRoute = saved[index].data;
        updateMapLine();
        map.flyTo({ center: currentRoute[0], zoom: 15 });
    }

    function clearMap() {
        if(confirm("ルートをクリアしますか？")) {
            currentRoute = [];
            updateMapLine();
            location.reload();
        }
    }
</script>
</body>
</html>
