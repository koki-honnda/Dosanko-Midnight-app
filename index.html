<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dosanko Midnight App</title>
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; overflow: hidden; background: #f0f0f0; height: 100dvh; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* 右上のメニューボタン */
        .menu-trigger {
            position: absolute; top: 15px; right: 15px; z-index: 100;
            background: white; width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 24px;
        }

        /* サイドパネル */
        .side-menu {
            position: absolute; top: 0; right: -310px; width: 280px; 
            height: 100dvh; background: rgba(255, 255, 255, 0.98); z-index: 90;
            transition: 0.3s; padding: 70px 15px 100px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px; 
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .side-menu.open { right: 0; }

        /* UIパーツ */
        .btn-group { display: flex; gap: 4px; }
        button {
            flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            background: white; font-size: 13px; font-weight: bold; cursor: pointer;
            min-height: 44px;
        }
        button.active { background: #ff4444 !important; color: white !important; }
        
        .section-title { font-size: 11px; color: #888; margin-top: 15px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .route-item { display: flex; align-items: center; gap: 8px; padding: 12px 5px; border-bottom: 1px solid #eee; font-size: 14px; }
        .fav-btn { font-size: 22px; color: #ccc; cursor: pointer; border:none; background:none; padding:0; flex-shrink: 0; }
        .fav-btn.active { color: #fbc02d; }
        .route-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; }
        .del-btn { color: #ff5252; font-size: 18px; border:none; background:none; cursor:pointer; padding:5px; flex-shrink: 0; }

        .undo-panel {
            position: absolute; bottom: 30px; left: 15px; z-index: 80;
            display: none; background: white; padding: 8px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* 補正中メッセージ */
        #status-msg {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            z-index: 80; background: rgba(0,0,0,0.7); color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 12px; display: none;
        }
    </style>
</head>
<body>

<div id="status-msg">道路に沿って修正中...</div>
<div class="menu-trigger" onclick="toggleMenu()">⋮</div>

<div id="side-menu" class="side-menu">
    <div class="section-title">ルート作成</div>
    <div class="btn-group">
        <button id="drawModeBtn" onclick="toggleMode('draw')">なぞる</button>
        <button id="autoModeBtn" onclick="toggleMode('auto')">自動検索</button>
    </div>
    <button id="saveBtn" onclick="saveToCloud()" style="background: #e3f2fd;">クラウドに保存・全員に共有</button>
    <button onclick="clearCurrent()" style="font-weight: normal; font-size: 11px; color: #666;">表示中のルートをリセット</button>

    <div class="section-title">みんなのルート</div>
    <div id="route-list">読み込み中...</div>

    <div class="section-title">設定</div>
    <button onclick="toggleTracking()" id="trackBtn">追従モード: OFF</button>
    <button onclick="requestLocation()">現在地を再表示</button>
    <button onclick="openGoogleMaps()" style="font-weight: normal;">Googleマップで開く</button>
    <button onclick="fullReset()" style="color: #ff5252; font-size: 11px; margin-top: 20px;">アプリを初期化</button>
</div>

<div id="undo-panel" class="undo-panel">
    <button onclick="undoLastAction()" style="background: #333; color: white; border: none;">↩ 1つ戻す (やり直し)</button>
</div>

<div id="map"></div>

<script>
    // --- Firebase設定 ---
    const firebaseConfig = {
        apiKey: "AIzaSyCM1JORf6ntrSjgD8_Scx1aogVmmjoMmYk",
        authDomain: "dosanko-midnight-app.firebaseapp.com",
        projectId: "dosanko-midnight-app",
        storageBucket: "dosanko-midnight-app.firebasestorage.app",
        messagingSenderId: "740298034300",
        appId: "1:740298034300:web:05ea779fddaf7fab480df9",
        measurementId: "G-0B0NF4EBLG",
        databaseURL: "https://dosanko-midnight-app-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    if(!localStorage.getItem('dosanko_user_id')) {
        localStorage.setItem('dosanko_user_id', 'u_' + Math.random().toString(36).substr(2, 9));
    }
    const MY_ID = localStorage.getItem('dosanko_user_id');

    // --- 地図初期設定 ---
    const SAPPORO = [141.3545, 43.0
