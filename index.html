<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dosanko Midnight App</title>
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- Firebase SDK (äº’æ›ãƒ¢ãƒ¼ãƒ‰) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; overflow: hidden; background: #f0f0f0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* å³ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */
        .menu-trigger {
            position: absolute; top: 15px; right: 15px; z-index: 100;
            background: white; width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 24px;
        }

        /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
        .side-menu {
            position: absolute; top: 0; right: -310px; width: 280px; height: 100%;
            background: rgba(255, 255, 255, 0.98); z-index: 90;
            transition: 0.3s; padding: 70px 10px 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 8px; overflow-y: auto;
        }
        .side-menu.open { right: 0; }

        .btn-group { display: flex; gap: 4px; }
        button {
            flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            background: white; font-size: 13px; font-weight: bold; cursor: pointer;
        }
        button.active { background: #ff4444 !important; color: white !important; }
        
        .section-title { font-size: 11px; color: #888; margin-top: 10px; font-weight: bold; text-transform: uppercase; }
        
        /* ãƒ«ãƒ¼ãƒˆãƒªã‚¹ãƒˆ */
        .route-item { 
            display: flex; align-items: center; gap: 8px;
            padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; background: #fff; border-radius: 4px; margin-bottom: 4px;
        }
        .fav-btn { font-size: 20px; color: #ccc; cursor: pointer; border:none; background:none; padding:0; }
        .fav-btn.active { color: #fbc02d; }
        .route-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .del-btn { color: #ff5252; font-size: 18px; border:none; background:none; cursor:pointer; padding:5px; }

        /* å·¦ä¸‹ã®ã‚„ã‚Šç›´ã—ãƒ‘ãƒãƒ« */
        .undo-panel {
            position: absolute; bottom: 30px; left: 15px; z-index: 80;
            display: none; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="menu-trigger" onclick="toggleMenu()">â‹®</div>

<div id="side-menu" class="side-menu">
    <div class="section-title">ãƒ«ãƒ¼ãƒˆä½œæˆ</div>
    <div class="btn-group">
        <button id="drawModeBtn" onclick="toggleMode('draw')">ãªãã‚‹</button>
        <button id="autoModeBtn" onclick="toggleMode('auto')">è‡ªå‹•æ¤œç´¢</button>
    </div>
    <button id="saveBtn" onclick="saveToCloud()" style="background: #e3f2fd;">ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ãƒ»å…¨å“¡ã«å…±æœ‰</button>
    <button onclick="clearCurrent()" style="font-weight: normal; font-size: 11px;">è¡¨ç¤ºä¸­ã®ãƒ«ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>

    <div class="section-title">ã¿ã‚“ãªã®ãƒ«ãƒ¼ãƒˆ</div>
    <div id="route-list">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div class="section-title">è¨­å®š</div>
    <button onclick="toggleTracking()" id="trackBtn">è¿½å¾“ãƒ¢ãƒ¼ãƒ‰: OFF</button>
    <button onclick="requestLocation()">ç¾åœ¨åœ°ã‚’è¡¨ç¤º</button>
</div>

<div id="undo-panel" class="undo-panel">
    <button onclick="undoLastAction()">â†© 1ã¤æˆ»ã™ (ã‚„ã‚Šç›´ã—)</button>
</div>

<div id="map"></div>

<script>
    // --- Firebaseè¨­å®šï¼ˆæä¾›æƒ…å ±ã‚’åæ˜ ï¼‰ ---
    const firebaseConfig = {
        apiKey: "AIzaSyCM1JORf6ntrSjgD8_Scx1aogVmmjoMmYk",
        authDomain: "dosanko-midnight-app.firebaseapp.com",
        projectId: "dosanko-midnight-app",
        storageBucket: "dosanko-midnight-app.firebasestorage.app",
        messagingSenderId: "740298034300",
        appId: "1:740298034300:web:05ea779fddaf7fab480df9",
        measurementId: "G-0B0NF4EBLG",
        // databaseURLã¯é€šå¸¸ã“ã®å½¢å¼ã«ãªã‚Šã¾ã™ã€‚Firebaseç”»é¢ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        databaseURL: "https://dosanko-midnight-app-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // å‰Šé™¤æ¨©é™ã®ãŸã‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆã‚¹ãƒãƒ›ã”ã¨ã«ä¿å­˜ï¼‰
    if(!localStorage.getItem('dosanko_user_id')) {
        localStorage.setItem('dosanko_user_id', 'u_' + Math.random().toString(36).substr(2, 9));
    }
    const MY_ID = localStorage.getItem('dosanko_user_id');

    // --- åœ°å›³åˆæœŸè¨­å®š (æœ­å¹Œ) ---
    const SAPPORO = [141.3545, 43.0621];
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: { 'osm': { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256, attribution: 'Â© OSM' } },
            layers: [{ id: 'osm-layer', type: 'raster', source: 'osm' }]
        },
        center: SAPPORO, zoom: 14
    });

    let currentRoute = [];
    let routeHistory = []; 
    let mode = 'none';
    let isTracking = false;

    map.on('load', () => {
        map.addSource('route', { type: 'geojson', data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [] } } });
        map.addLayer({ id: 'route-layer', type: 'line', source: 'route', paint: { 'line-color': '#ff4444', 'line-width': 6, 'line-opacity': 0.7 } });
        
        map.addSource('user-pos', { type: 'geojson', data: { type: 'Point', coordinates: [] } });
        map.addLayer({ id: 'user-area', type: 'circle', source: 'user-pos', paint: { 'circle-radius': 15, 'circle-color': '#007bff', 'circle-opacity': 0.4 } });

        syncCloudRoutes(); // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ«ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
        requestLocation(); // åˆæœŸä½ç½®å–å¾—
    });

    // --- ã‚„ã‚Šç›´ã—æ©Ÿèƒ½ ---
    function saveHistory() {
        routeHistory.push(JSON.stringify(currentRoute));
        if(routeHistory.length > 30) routeHistory.shift();
    }

    function undoLastAction() {
        if(routeHistory.length === 0) return;
        currentRoute = JSON.parse(routeHistory.pop());
        updateMapLine();
    }

    // --- ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ãƒ»åŒæœŸ ---
    function saveToCloud() {
        if (currentRoute.length < 2) return alert("ãƒ«ãƒ¼ãƒˆã‚’æã„ã¦ãã ã•ã„");
        const name = prompt("ãƒ«ãƒ¼ãƒˆã®åå‰", "æœ­å¹Œãƒ«ãƒ¼ãƒˆ " + new Date().toLocaleTimeString());
        if (!name) return;

        const newRef = db.ref('shared_routes').push();
        newRef.set({
            name: name,
            coords: currentRoute,
            creator: MY_ID,
            timestamp: Date.now()
        }).then(() => {
            alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼ã¿ã‚“ãªã®ãƒªã‚¹ãƒˆã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚");
            clearCurrent();
        });
    }

    function syncCloudRoutes() {
        db.ref('shared_routes').on('value', (snapshot) => {
            const list = document.getElementById('route-list');
            list.innerHTML = '';
            const data = snapshot.val();
            const favs = JSON.parse(localStorage.getItem('dosanko_favs') || '[]');

            const routes = [];
            for(let id in data) {
                routes.push({ id, ...data[id], isFav: favs.includes(id) });
            }

            // ãŠæ°—ã«å…¥ã‚Šé †ã€æ¬¡ã«æ–°ã—ã„é †
            routes.sort((a, b) => (b.isFav - a.isFav) || (b.timestamp - a.timestamp));

            routes.forEach(r => {
                const item = document.createElement('div');
                item.className = 'route-item';
                item.innerHTML = `
                    <button class="fav-btn ${r.isFav?'active':''}" onclick="toggleFav('${r.id}')">${r.isFav?'â˜…':'â˜†'}</button>
                    <div class="route-name" onclick="loadCloudRoute('${r.id}')">${r.name}</div>
                    ${r.creator === MY_ID ? `<button class="del-btn" onclick="deleteRoute('${r.id}')">ğŸ—‘</button>` : ''}
                `;
                list.appendChild(item);
            });
        });
    }

    function deleteRoute(id) {
        if(confirm("ã“ã®ãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆä½œæˆè€…ã®ã¿å‰Šé™¤å¯èƒ½ã§ã™ï¼‰")) {
            db.ref('shared_routes/' + id).remove();
        }
    }

    function toggleFav(id) {
        let favs = JSON.parse(localStorage.getItem('dosanko_favs') || '[]');
        if(favs.includes(id)) favs = favs.filter(f => f !== id);
        else favs.push(id);
        localStorage.setItem('dosanko_favs', JSON.stringify(favs));
        // Firebaseã®ãƒªã‚¹ãƒŠãƒ¼ãŒè‡ªå‹•çš„ã«å†æç”»ã—ã¦ãã‚Œã¾ã™
    }

    function loadCloudRoute(id) {
        db.ref('shared_routes/' + id).once('value', (s) => {
            currentRoute = s.val().coords;
            updateMapLine();
            map.flyTo({ center: currentRoute[0] });
            toggleMenu();
        });
    }

    // --- ãƒ«ãƒ¼ãƒˆæç”»ãƒ»æ“ä½œ ---
    function toggleMode(m) {
        mode = (mode === m) ? 'none' : m;
        document.getElementById('drawModeBtn').classList.toggle('active', mode === 'draw');
        document.getElementById('autoModeBtn').classList.toggle('active', mode === 'auto');
        document.getElementById('undo-panel').style.display = (mode === 'draw') ? 'block' : 'none';
        
        if (mode === 'draw') {
            map.dragPan.disable();
            map.touchZoomRotate.disable();
            toggleMenu();
        } else {
            map.dragPan.enable();
            map.touchZoomRotate.enable();
        }
    }

    const handleMove = (e) => {
        if (mode !== 'draw') return;
        if (currentRoute.length % 5 === 0) saveHistory();
        currentRoute.push([e.lngLat.lng, e.lngLat.lat]);
        updateMapLine();
    };
    map.on('mousemove', handleMove);
    map.on('touchmove', handleMove);

    map.on('click', async (e) => {
        if (mode !== 'auto') return;
        saveHistory();
        const coords = [e.lngLat.lng, e.lngLat.lat];
        if (currentRoute.length > 0) {
            const start = currentRoute[currentRoute.length - 1];
            const url = `https://router.project-osrm.org/route/v1/walking/${start[0]},${start[1]};${coords[0]},${coords[1]}?overview=full&geometries=geojson`;
            const res = await fetch(url).then(r => r.json());
            if (res.routes[0]) {
                currentRoute = currentRoute.concat(res.routes[0].geometry.coordinates);
                updateMapLine();
            }
        } else {
            currentRoute.push(coords);
            updateMapLine();
        }
    });

    function updateMapLine() {
        const data = currentRoute.length > 1 ? currentRoute : [[0,0],[0,0]];
        map.getSource('route').setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: data } });
    }

    function clearCurrent() { currentRoute = []; routeHistory = []; updateMapLine(); }
    
    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }

    // --- ç¾åœ¨åœ°ãƒ»è¿½å¾“ ---
    function requestLocation() {
        navigator.geolocation.getCurrentPosition(pos => {
            const coords = [pos.coords.longitude, pos.coords.latitude];
            map.getSource('user-pos').setData({ type: 'Point', coordinates: coords });
            map.flyTo({ center: coords });
        }, null, { enableHighAccuracy: false });
    }

    function startLocationWatcher() {
        navigator.geolocation.watchPosition(pos => {
            const coords = [pos.coords.longitude, pos.coords.latitude];
            if (map.getSource('user-pos')) map.getSource('user-pos').setData({ type: 'Point', coordinates: coords });
            if (isTracking) map.easeTo({ center: coords });
        }, null, { enableHighAccuracy: false });
    }
    startLocationWatcher();

    function toggleTracking() {
        isTracking = !isTracking;
        document.getElementById('trackBtn').classList.toggle('active', isTracking);
        document.getElementById('trackBtn').innerText = `è¿½å¾“ãƒ¢ãƒ¼ãƒ‰: ${isTracking?'ON':'OFF'}`;
        if(isTracking) toggleMenu();
    }

    function openGoogleMaps() {
        const c = map.getCenter();
        window.open(`https://www.google.com/maps/@${c.lat},${c.lng},15z`);
    }
</script>
</body>
</html>
